<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="main.css" />
  <title>CHECKLIST</title>
</head>

<body>
  <main>
    <img src="../asset/logo-telkomsel-baru.DYhv_uL8_1T5nit-removebg-preview.png" alt="Logo Telkomsel" class="logo">
    <h1>Form Checklist</h1>
    <div id="body">
      <form id="myForm">

      </form>
    </div>
  </main>


  <!-- `http://127.0.0.1:8000/api/${ttc}/checklist/list_dp_tables/user_bio/jabatan/ME`
`http://127.0.0.1:8000/api/${ttc}/data_potensi/generate_columns/${item}`
`http://127.0.0.1:8000/api/${ttc}/checklist/tableReportList` -->
  <script src="loder.js"></script>
  <script>
    const ttc = localStorage.getItem('ttc');
    console.log(ttc);

    fetch(`http://127.0.0.1:8000/api/${ttc}/checklist/tableReportList`)
      .then(res => res.json())
      .then(data => {
        const staffformArray = data.staffform;
        const form = document.getElementById("myForm");

        staffformArray.forEach(value => {
          // Buat div untuk section
          const div = document.createElement("div");
          div.id = value; // id = value dari array

          // Tambahkan heading <h2> ke dalam div
          const heading = document.createElement("h2");
          heading.textContent = value; // teks heading = value dari array
          div.appendChild(heading);

          // Masukkan div ke form
          form.appendChild(div);

          // Generate input untuk div tersebut
          generateInputRow(value).then(() => {
            appendButton("myForm", "Kirim Data", () => submitFormDataNested("myForm"));
          });
        });
      })
      .catch(err => console.error("Error:", err));



    function getInputType(dataType) {
      // Mapping tipe data dari API ke tipe input HTML
      switch (dataType) {
        case "datetime":
          return "datetime-local";
        case "int":
          return "number";
        case "varchar":
        default:
          return "text";
      }
    }

    async function generateInputRow(idParent) {
      try {
        const form = document.getElementById(idParent);

        // Ambil struktur kolom
        const resCols = await fetch(`http://127.0.0.1:8000/api/${ttc}/data_potensi/generate_columns/report_info`);
        const columns = await resCols.json();

        // Ambil data petugas ME
        const resUsers = await fetch(`http://127.0.0.1:8000/api/${ttc}/checklist/list_dp_tables/user_bio/jabatan/ME`);
        const users = await resUsers.json();

        columns.forEach(col => {
          // Skip kolom no_report
          if (col.COLUMN_NAME === "no_report") return;
          if (col.COLUMN_NAME === "status") return;

          const label = document.createElement("label");
          label.setAttribute("for", col.COLUMN_NAME);
          label.className = "form-label";
          label.textContent = col.COLUMN_NAME;

          let inputElement;

          if (["petugasME", "petugasME2", "petugasME3", "petugasME4"].includes(col.COLUMN_NAME)) {
            // Select dari API ME
            inputElement = document.createElement("select");
            inputElement.name = col.COLUMN_NAME;
            inputElement.id = col.COLUMN_NAME;
            inputElement.className = "form-select";

            const defaultOpt = document.createElement("option");
            defaultOpt.value = "";
            defaultOpt.textContent = "-- Pilih Petugas --";
            inputElement.appendChild(defaultOpt);

            users.forEach(user => {
              const opt = document.createElement("option");
              opt.value = user.id;
              opt.textContent = user.Nama;
              inputElement.appendChild(opt);
            });

          } else if (col.COLUMN_NAME === "jenis_report") {
            // Select dengan opsi tetap
            inputElement = document.createElement("select");
            inputElement.name = col.COLUMN_NAME;
            inputElement.id = col.COLUMN_NAME;
            inputElement.className = "form-select";

            const options = ["KWH & Suhu", "Ceklist", "Genset1", "Genset2"];

            const defaultOpt = document.createElement("option");
            defaultOpt.value = "";
            defaultOpt.textContent = "-- Pilih Jenis Report --";
            inputElement.appendChild(defaultOpt);

            options.forEach(optValue => {
              const opt = document.createElement("option");
              opt.value = optValue;
              opt.textContent = optValue;
              inputElement.appendChild(opt);
            });

          } else {
            // Input biasa
            inputElement = document.createElement("input");
            inputElement.type = getInputType(col.DATA_TYPE);
            inputElement.name = col.COLUMN_NAME;
            inputElement.id = col.COLUMN_NAME;
            inputElement.className = "form-control";
          }

          const div = document.createElement("div");
          div.className = "mb-3";
          div.appendChild(label);
          div.appendChild(inputElement);

          form.appendChild(div);
        });

      } catch (err) {
        console.error("Error:", err);
      }
    }


    function appendButton(idParent, buttonText = "Submit", onClickHandler = null) {
      const form = document.getElementById(idParent);
      if (!form) {
        console.error("Form not found:", idParent);
        return;
      }

      const btn = document.createElement("button");
      btn.type = "button"; // bisa diubah jadi "submit" kalau mau submit form biasa
      btn.textContent = buttonText;
      btn.className = "btn btn-primary w-100"; // styling Bootstrap, sesuaikan kalau pakai CSS sendiri

      if (typeof onClickHandler === "function") {
        btn.addEventListener("click", onClickHandler);
      }

      form.appendChild(btn);  // <<< ini yang kurang
    }


    function submitFormDataNested(formId) {
      const form = document.getElementById(formId);
      if (!form) return console.error("Form not found:", formId);

      const formData = {};

      // Ambil semua div langsung di dalam form
      const sections = form.querySelectorAll(":scope > div");

      sections.forEach(section => {
        const sectionId = section.id;
        if (!sectionId) return;

        const sectionData = {};
        // Ambil semua input/select/textarea dalam section itu
        section.querySelectorAll("input, select, textarea").forEach(el => {
          if (!el.name) return;
          sectionData[el.name] = el.value;
        });

        formData[sectionId] = sectionData;
      });

      console.log("Nested Form Data:", formData);

      // Kirim ke API
      fetch(`http://127.0.0.1:8000/api/${ttc}/checklist/sendInfoReport`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      })
        .then(res => res.json())
        .then(response => {
          console.log("Response from API:", response);

          // Ambil jenis_report
          // Misal formData dikirim sebagai key 'report_info'
          const jenisReport = response.received.report_info.jenis_report;
          const receivedObj = response.received;

          console.log("Jenis Report:", jenisReport);
          sessionStorage.setItem('jenisReport', jenisReport);
          sessionStorage.setItem('report_info', JSON.stringify(receivedObj));

          const received = JSON.parse(sessionStorage.getItem('report_info'));
          console.log(received);
          switch (jenisReport) {
            case 'Genset1':
              window.location.href = "genset.html";
              break;
            case 'Genset2':
              window.location.href = "genset.html";
              break;
            default:
              window.location.href = "kwhSuhu.html";
              break;
          }
        })
        .catch(err => console.error("Error sending data:", err));
    }





  </script>
</body>

</html>
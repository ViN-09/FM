<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="main.css" />
  <title>CHECKLIST</title>
</head>

<body>
  <main>
    <h1>Form Checklist</h1>
    <div id="bodyform">
      <form id="myForm"></form>
    </div>
  </main>

  <script>
    async function getPetugasME() {
      try {
        const res = await fetch(
          'http://127.0.0.1:8000/api/ttc_teling/checklist/list_dp_tables/user_bio/jabatan/ME'
        );
        if (!res.ok) throw new Error('Gagal ambil data petugas ME');
        return await res.json();
      } catch (err) {
        console.warn(err);
        return [];
      }
    }

    async function loadStaffInfoForm(url, containerId, petugasOptions) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`Element dengan id "${containerId}" gak ketemu!`);
        return;
      }
      container.innerHTML = '';

      const jenisReportOptions = ['Ceklist', 'KWH & LBP', 'Genset 1', 'Genset 2'];

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Gagal ambil data kolom (${url})`);
        const columns = await res.json();

        for (const col of columns) {
          const name = col.COLUMN_NAME;
          const type = col.DATA_TYPE;

          if (name === 'no_report') continue;

          const wrapper = document.createElement('div');
          wrapper.className = 'form-group mb-3';

          const label = document.createElement('label');
          label.textContent = name.replace(/_/g, ' ').toUpperCase();
          label.setAttribute('for', `${name}_from_${containerId}`);

          let field;

          if (['petugasME', 'petugasME2', 'petugasME3', 'petugasME4'].includes(name)) {
            field = document.createElement('select');
            field.name = name;
            field.id = `${name}_from_${containerId}`;
            field.className = 'form-control';

            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = '-- Pilih --';
            field.appendChild(defaultOpt);

            petugasOptions.forEach(p => {
              const opt = document.createElement('option');
              opt.value = p.id;
              opt.textContent = p.Nama;
              field.appendChild(opt);
            });

          } else if (name === 'jenis_report') {
            field = document.createElement('select');
            field.name = name;
            field.id = `${name}_from_${containerId}`;
            field.className = 'form-control';

            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = '-- Pilih --';
            field.appendChild(defaultOpt);

            jenisReportOptions.forEach(optVal => {
              const opt = document.createElement('option');
              opt.value = optVal;
              opt.textContent = optVal;
              field.appendChild(opt);
            });

          } else {
            let inputType = 'text';
            if (type.includes('date')) inputType = 'datetime-local';
            else if (type.includes('int') || type.includes('decimal')) inputType = 'number';

            field = document.createElement('input');
            field.type = inputType;
            field.name = name;
            field.id = `${name}_from_${containerId}`;
            field.className = 'form-control';
          }

          wrapper.appendChild(label);
          wrapper.appendChild(field);
          container.appendChild(wrapper);
        }

        // Tombol Gas
        const btnGas = document.createElement('button');
        btnGas.type = 'button';
        btnGas.className = 'btn btn-primary mt-3';
        btnGas.textContent = 'Gas';
        container.appendChild(btnGas);

      } catch (err) {
        container.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    async function appendFromAPI() {
      try {
        const [response, petugasOptions] = await Promise.all([
          fetch("http://127.0.0.1:8000/api/ttc_teling/checklist/tableReportList"),
          getPetugasME()
        ]);

        const data = await response.json();

        if (!Array.isArray(data)) {
          console.error("Data bukan array:", data);
          return;
        }

        const form = document.querySelector("form");

        // Proses satu per satu agar server gak kebanjiran (hindari 429)
        for (const item of data) {
          // Buat container div untuk tiap tabel
          const div = document.createElement("div");
          div.id = item;
          div.style.border = '1px solid #ccc';
          div.style.padding = '10px';
          div.style.marginBottom = '15px';

          // Judul
          const h3 = document.createElement('h3');
          h3.textContent = item.toUpperCase();
          div.appendChild(h3);

          form.appendChild(div);

          // Load form kolom di dalam div tersebut
          await loadStaffInfoForm(
            `http://127.0.0.1:8000/api/ttc_teling/data_potensi/generate_columns/${item}`,
            item,
            petugasOptions
          );

          await new Promise(r => setTimeout(r, 300)); // delay 300ms antar request biar aman
        }

      } catch (err) {
        console.error("Gagal fetch API:", err);
      }
    }

    // Mulai proses
    appendFromAPI();
  </script>
</body>

</html>

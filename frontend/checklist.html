<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="checklist.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <title>FACILITY MONITORING</title>
</head>

<body>
    <main>
        <div id="bodychecklist">
            <h1 id="title">CHECKLIST</h1>
            <div id="bodychecklist-header">
                <div id="bodychecklist-header-seaerch">
                    <input type="date" id="tanggalPicker" name="bulan" class="form-control" />
                    <button class="btn btn-primary" id="btnSearch">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <div id="bodychecklist-header-SubMenu">
                    <button class="btn btn-warning" id="kwh">
                        <i class="bi bi-speedometer"></i>
                    </button>
                    <button class="btn btn-warning" id="pue">
                        <i class="bi bi-clipboard2-data"></i>
                    </button>
                    <button class="btn btn-warning" id="gen1">
                        <i class="bi bi-building-gear">1</i>
                    </button>
                    <button class="btn btn-warning" id="gen2">
                        <i class="bi bi-building-gear">2</i>
                    </button>
                </div>

                <div id="bodychecklist-header-extrabutton">
                    <button class="btn btn-success" id="btnCreate">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="btn btn-warning" id="btnReport">
                        <i class="bi bi-card-checklist"></i>
                    </button>
                    <button class="btn btn-warning" id="btnExport">
                        <i class="bi bi-download"></i>
                    </button>
                </div>

            </div>

            <!-- Div untuk tabel utama & sub-tabel -->
            <div id="bodychecklist-body" class="badan"></div>
            <div id="bodychecklist-bodyGenset1" class="badan"></div>
            <div id="bodychecklist-bodyGenset2" class="badan"></div>
            <div id="bodychecklist-bodySKWH" class="badan"></div>
        </div>

        <!-- Popup modal -->
        <div id="popupOverlay" class="popup-overlay"></div>
        <div id="popupModal" class="popup-modal">
            <div class="popup-header">
                <h2>Report</h2>
                <button class="popup-close">&times;</button>
            </div>
            <div id="report-selector"></div>
            <div class="popup-body">
                <div>
                    <pre id="isi_report"></pre>
                    <button id="btnCopy">Copy</button>
                </div>
            </div>
        </div>
    </main>

    <script src="js/sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/locale/id.js"></script>
    <script>
        // === Init Hide/Show Body ===
        function hideAllBadan() {
            document.querySelectorAll('.badan').forEach(el => {
                el.classList.add('hide');
            });
        }

        function showBadanById(id) {
            hideAllBadan();
            const el = document.getElementById(id);
            if (el) el.classList.remove('hide');
        }

        // Awal load â†’ tampilkan PUE
        hideAllBadan();
        showBadanById("bodychecklist-body");

        // === Variabel Global ===
        let reportCeklist = [];
        let reportGenset1 = [];
        let reportGenset2 = [];
        let reportKWH = [];

        const ttc = localStorage.getItem('ttc');
        const host = localStorage.getItem('host');
        console.log(host)
        const tanggalInput = document.getElementById('tanggalPicker');
        const btnSearch = document.getElementById('btnSearch');

        // Format date ke YYYY-MM-DD
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // === Fungsi generic fetch & render tabel ===
        async function loadChecklistSubTable(apiURL, containerId, addTo) {
            const container = document.getElementById(containerId);
            try {
                const response = await fetch(apiURL);
                if (!response.ok) throw new Error('Gagal ambil data');
                const data = await response.json();

                if (!data || Object.keys(data).length === 0) {
                    container.innerHTML = '<p>Tidak ada data untuk tanggal tersebut.</p>';
                    return;
                }

                const firstKey = Object.keys(data)[0];
                let columns = Object.keys(data[firstKey]);

                // daftar key yang di-skip
                const skipKeys = [
                    "ups1", "ups2", "rec1", "rec2", "rec3", "rec4", "rec5", "rec6", "rec7", "rec8", "rec9",
                    "TrafoCaps", "GensetTotal", "PACTotal", "RECTotal", "UPSTotal",
                    "GensetF", "PACF", "RECF", "UPSF", "Cuaca", "tanggal_formatted", "jam",
                    "Petugas1", "Petugas1NO", "Petugas2", "Petugas2NO", "Petugas3", "Petugas3NO",
                    "Petugas4", "Petugas4NO",
                    "lvmdp1_load_r_s", "lvmdp1_load_r_t", "lvmdp1_load_s_t", "lvmdp1_load_r_n",
                    "lvmdp1_load_s_n", "lvmdp1_load_t_n", "lvmdp1_load_lvmdp1_kva",
                    "lvmdp2_load_r_s", "lvmdp2_load_r_t", "lvmdp2_load_s_t", "lvmdp2_load_r_n",
                    "lvmdp2_load_s_n", "lvmdp2_load_t_n", "lvmdp2_kva",
                    "ups1_no", "ups1_brand", "ups1_type", "ups1_kw", "ups1_kva", "ups1_battery",
                    "ups1_runtime", "ups1_a", "ups1_occ",
                    "ups2_no", "ups2_brand", "ups2_type", "ups2_kw", "ups2_kva", "ups2_battery",
                    "ups2_runtime", "ups2_a", "ups2_occ",
                    "ups3_occ", "ups4_occ",
                    "dcpdu1_noDCPDU", "dcpdu1_source", "dcpdu1_aV", "dcpdu1_aA", "dcpdu1_bV", "dcpdu1_bA",
                    "dcpdu1_cV", "dcpdu1_cA", "dcpdu1_dV", "dcpdu1_dA",
                    "dcpdu2_noDCPDU", "dcpdu2_source", "dcpdu2_aV", "dcpdu2_aA", "dcpdu2_bV", "dcpdu2_bA",
                    "dcpdu2_cV", "dcpdu2_cA", "dcpdu2_dV", "dcpdu2_dA",
                    "dcpdu3_noDCPDU", "dcpdu3_source", "dcpdu3_aV", "dcpdu3_aA", "dcpdu3_bV", "dcpdu3_bA",
                    "dcpdu3_cV", "dcpdu3_cA", "dcpdu3_dV", "dcpdu3_dA",
                    "dcpdu4_noDCPDU", "dcpdu4_source", "dcpdu4_aV", "dcpdu4_aA", "dcpdu4_bV", "dcpdu4_bA",
                    "dcpdu4_cV", "dcpdu4_cA", "dcpdu4_dV", "dcpdu4_dA",
                    "rec1_Nama", "rec1_Brand", "rec1_BebanTotal", "rec1_CapsRec", "rec1_TotalLoad", "rec1_Ocupanccy", "rec1_Status",
                    "rec2_Nama", "rec2_Brand", "rec2_BebanTotal", "rec2_CapsRec", "rec2_TotalLoad", "rec2_Ocupanccy", "rec2_Status",
                    "rec3_Nama", "rec3_Brand", "rec3_BebanTotal", "rec3_CapsRec", "rec3_TotalLoad", "rec3_Ocupanccy", "rec3_Status",
                    "rec4_Nama", "rec4_Brand", "rec4_BebanTotal", "rec4_CapsRec", "rec4_TotalLoad", "rec4_Ocupanccy", "rec4_Status",
                    "rec5_Nama", "rec5_Brand", "rec5_BebanTotal", "rec5_CapsRec", "rec5_TotalLoad", "rec5_Ocupanccy", "rec5_Status",
                    "rec6_Nama", "rec6_Brand", "rec6_BebanTotal", "rec6_CapsRec", "rec6_TotalLoad", "rec6_Ocupanccy", "rec6_Status",
                    "rec7_Nama", "rec7_Brand", "rec7_BebanTotal", "rec7_CapsRec", "rec7_TotalLoad", "rec7_Ocupanccy", "rec7_Status",
                    "rec8_Nama", "rec8_Brand", "rec8_BebanTotal", "rec8_CapsRec", "rec8_TotalLoad", "rec8_Ocupanccy", "rec8_Status",
                    "rec9_Nama", "rec9_Brand", "rec9_BebanTotal", "rec9_CapsRec", "rec9_TotalLoad", "rec9_Ocupanccy", "rec9_Status",
                    "pac1_Nama", "pac1_Tipe", "pac1_Suhu", "pac1_Kelembaban", "pac1_SetPoint", "pac1_Status",
                    "pac2_Nama", "pac2_Tipe", "pac2_Suhu", "pac2_Kelembaban", "pac2_SetPoint", "pac2_Status",
                    "pac3_Nama", "pac3_Tipe", "pac3_Suhu", "pac3_Kelembaban", "pac3_SetPoint", "pac3_Status",
                    "pac4_Nama", "pac4_Tipe", "pac4_Suhu", "pac4_Kelembaban", "pac4_SetPoint", "pac4_Status",
                    "pac5_Nama", "pac5_Tipe", "pac5_Suhu", "pac5_Kelembaban", "pac5_SetPoint", "pac5_Status",
                    "pac6_Nama", "pac6_Tipe", "pac6_Suhu", "pac6_Kelembaban", "pac6_SetPoint", "pac6_Status",
                    "pac7_Nama", "pac7_Tipe", "pac7_Suhu", "pac7_Kelembaban", "pac7_SetPoint", "pac7_Status",
                    "pac8_Nama", "pac8_Tipe", "pac8_Suhu", "pac8_Kelembaban", "pac8_SetPoint", "pac8_Status",
                    "pac9_Nama", "pac9_Tipe", "pac9_Suhu", "pac9_Kelembaban", "pac9_SetPoint", "pac9_Status",
                    "pac10_Nama", "pac10_Tipe", "pac10_Suhu", "pac10_Kelembaban", "pac10_SetPoint", "pac10_Status"
                ];

                columns = columns.filter(col => !skipKeys.includes(col));

                // Build table
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.border = '1';

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.innerText = col.replace(/_/g, ' ').toUpperCase();
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                let indexROW = 0;
                Object.values(data).forEach(rowData => {
                    const row = document.createElement('tr');
                    columns.forEach(col => {
                        const td = document.createElement('td');
                        td.innerText = rowData[col];
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                    indexROW++;
                });
                table.appendChild(tbody);

                container.innerHTML = '';
                container.appendChild(table);
                console.log(indexROW)

                // Simpan ke variabel global
                switch (addTo) {
                    case 'genset1': reportGenset1 = data[indexROW]; console.log('g1'); console.log(reportGenset1); break;
                    case 'genset2': reportGenset2 = data[indexROW]; console.log('g2'); console.log(reportGenset2); break;
                    case 'pue': reportCeklist = data[indexROW]; console.log('reportCeklist'); console.log(reportCeklist); break;
                    case 'kwh': reportKWH = data[indexROW]; console.log('kwh'); console.log(reportKWH); break;
                }

                // ceklistTeling(reportCeklist)

            } catch (error) {
                container.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
            }
        }

        // === Load semua tabel berdasarkan tanggal ===
        async function loadAllTables(tanggal) {
            const apiMainURL = `http://${host}/api/${ttc}/checklist/ChecklistPUE?jenis_report=Ceklist&tanggal=${tanggal}`;
            loadChecklistSubTable(apiMainURL, 'bodychecklist-body', "pue");

            const apiG1URL = `http://${host}/api/${ttc}/checklist/Genset1?jenis_report=Genset1&tanggal=${tanggal}`;
            loadChecklistSubTable(apiG1URL, 'bodychecklist-bodyGenset1', "genset1");

            const apiG2URL = `http://${host}/api/${ttc}/checklist/Genset2?jenis_report=Genset2&tanggal=${tanggal}`;
            loadChecklistSubTable(apiG2URL, 'bodychecklist-bodyGenset2', "genset2");

            const jenisReport = "KWH & Suhu";
            const apiKWHURL = `http://${host}/api/${ttc}/checklist/SKWH?jenis_report=${encodeURIComponent(jenisReport)}&tanggal=${tanggal}`;
            loadChecklistSubTable(apiKWHURL, 'bodychecklist-bodySKWH', "kwh");
        }

        // === Inisialisasi tanggal ===
        const today = new Date();
        tanggalInput.value = formatDate(today);
        loadAllTables(tanggalInput.value);

        btnSearch.addEventListener('click', () => {
            if (tanggalInput.value) loadAllTables(tanggalInput.value);
        });
        tanggalInput.addEventListener('change', () => {
            if (tanggalInput.value) loadAllTables(tanggalInput.value);
        });

        // === Navigasi Submenu Button ===
        const subMenuContainer = document.getElementById('bodychecklist-header-SubMenu');
        if (subMenuContainer) {
            subMenuContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    switch (btn.id) {
                        case 'pue': showBadanById("bodychecklist-body"); break;
                        case 'gen1': showBadanById("bodychecklist-bodyGenset1"); break;
                        case 'gen2': showBadanById("bodychecklist-bodyGenset2"); break;
                        case 'kwh': showBadanById("bodychecklist-bodySKWH"); break;
                    }
                });
            });
        }

        // === Export tabel utama (PUE) ===
        document.getElementById('btnExport').addEventListener('click', () => {
            const table = document.querySelector('#bodychecklist-body table');
            if (!table) return alert('Data tabel belum tersedia untuk diexport!');
            const wb = XLSX.utils.table_to_book(table, { sheet: "Checklist" });
            XLSX.writeFile(wb, `checklist_export_${new Date().toISOString().slice(0, 10)}.xlsx`);
        });

        // === Tombol navigasi Create ===
        document.getElementById('btnCreate').addEventListener('click', () => {
            window.location.href = 'checklist/main.html';
        });

        // === Popup modal report ===
        document.addEventListener("DOMContentLoaded", () => {
            const btnReport = document.getElementById('btnReport');
            const popupOverlay = document.getElementById('popupOverlay');
            const popupModal = document.getElementById('popupModal');
            const popupClose = document.querySelector('.popup-close');

            btnReport.addEventListener('click', () => {
                popupOverlay.style.display = 'block';
                popupModal.style.display = 'block';
            });
            popupClose.addEventListener('click', () => {
                popupOverlay.style.display = 'none';
                popupModal.style.display = 'none';
            });
            popupOverlay.addEventListener('click', () => {
                popupOverlay.style.display = 'none';
                popupModal.style.display = 'none';
            });

            // Render tombol report
            const reportSelector = document.getElementById("report-selector");
            if (ttc === 'ttc_teling') {
                reportSelector.innerHTML = `
                <button class="btn btn-warning" id="rep_kwh">KWH & Suhu</button>
                <button class="btn btn-warning" id="rep_checklist">Checklist</button>
                <button class="btn btn-warning" id="rep_genset1">Genset1</button>
                <button class="btn btn-warning" id="rep_genset2">Genset2</button>
            `;
                reportSelector.querySelectorAll("button").forEach(btn => {
                    btn.addEventListener("click", () => {
                        // Reset semua button
                        reportSelector.querySelectorAll("button").forEach(b => {
                            b.classList.remove("btn-primary", "active");
                            if (b.id !== "btnCreate") b.classList.add("btn-warning");
                        });

                        // Set button yang diklik jadi aktif
                        btn.classList.remove("btn-warning");
                        btn.classList.add("btn-primary", "active");

                        // Ambil ID button yang diklik
                        console.log("Button diklik ID:", btn.id);
                        const jenisReport = btn.id;

                        switch (jenisReport) {
                            case 'rep_checklist':
                                ceklistTeling(reportCeklist, reportGenset1, reportGenset2);
                                break;
                            case 'rep_kwh':
                                kwhTeling(reportKWH);
                                break;
                            case 'rep_genset1':
                                gen1Teling(reportGenset1);
                                break;
                            case 'rep_genset2':
                                gen2Teling(reportGenset2);
                                break;
                            default:
                                break;
                        }
                    });
                });
            }
        });

        function gen1Teling(data) {
            // kumpulin petugas (buang yg null)
            const petugas = [
                data.Petugas1,
                data.Petugas2,
                data.Petugas3,
                data.Petugas4
            ].filter(Boolean); // buang yg null

            // Convert tanki dan tangki ke number agar .toFixed bisa dipakai
            const bulanan = parseFloat(data.liter_bulanan) || 0;
            const harian = parseFloat(data.liter_harian) || 0;
            const suhu = parseFloat(data.suhu) || 0;

            // Hitung durasi dalam menit
            let durasiMenit = 0;
            if (data.gen_on && data.gen_off) {
                const onTime = new Date("1970-01-01T" + data.gen_on);
                const offTime = new Date("1970-01-01T" + data.gen_off);
                durasiMenit = Math.round((offTime - onTime) / 60000);
            }

            const isi = `
BERITA ACARA RUNNING GENSET 1

Petugas ME:
${petugas.join(" / ")}

Proses:
${data.proses}

Gedung:
TTC Teling

Hari/Tanggal:
${data.tanggal_formatted}

Running Time (WITA)
Genset On: ${data.gen_on}
Genset Off: ${data.gen_off}
Durasi: ${durasiMenit} Menit

Level BBM (Liter)
Tanki Bulanan Genset 1: ${bulanan.toFixed(0)} L
Tanki Harian Genset 1: ${harian.toFixed(0)} L

Suhu:
${suhu} Â°C

Hours Matter:
${data.hours_mater}
`;

            document.getElementById("isi_report").textContent = isi;
        }

        function gen2Teling(data) {
            // kumpulin petugas (buang yg null)
            const petugas = [
                data.Petugas1,
                data.Petugas2,
                data.Petugas3,
                data.Petugas4
            ].filter(Boolean);

            // Convert liter dan suhu ke number
            const bulanan = parseFloat(data.liter_bulanan) || 0;
            const harian = parseFloat(data.liter_harian) || 0;
            const suhu = parseFloat(data.suhu) || 0;

            // Hitung durasi dalam menit
            let durasiMenit = 0;
            if (data.gen_on && data.gen_off) {
                const onTime = new Date("1970-01-01T" + data.gen_on);
                const offTime = new Date("1970-01-01T" + data.gen_off);
                durasiMenit = Math.round((offTime - onTime) / 60000);
            }

            const isi = `
BERITA ACARA RUNNING GENSET 2a & 2b

Petugas ME:
${petugas.join(" / ")}

Proses:
${data.proses}

Gedung:
TTC Teling

Hari/Tanggal:
${data.tanggal_formatted}

Running Time (WITA)
Genset On: ${data.gen_on}
Genset Off: ${data.gen_off}
Durasi: ${durasiMenit} Menit

Level BBM (Liter)
Tanki Bulanan Genset 2: ${bulanan.toFixed(0)} L
Tanki Harian Genset 2: ${harian.toFixed(0)} L

Suhu:
${suhu} Â°C

Hours Matter 1:
${data.hours_mater1 || "-"}

Hours Matter 2:
${data.hours_mater2 || "-"}
`;

            document.getElementById("isi_report").textContent = isi;
        }

        function ceklistTeling(data, data2, data3) {
            function val(x) {
                return (x === null || x === undefined || x === "") ? "-" : x;
            }

            function valNum(x) {
                return Math.round(Number(x) || 0);
            }

            // Handle petugas dari Petugas1..4
            let petugas = [data.Petugas1, data.Petugas2, data.Petugas3, data.Petugas4].filter(Boolean);
            let petugasList = petugas.length > 0 ? petugas.map(p => ` - ${p}`).join("\n") : " - Tidak ada petugas standby";
            const totalSolar =
                Number(data2.liter_bulanan || 0) +
                Number(data2.liter_harian || 0) +
                Number(data3.liter_bulanan || 0) +
                Number(data3.liter_harian || 0);
            const occBBM = Math.round((totalSolar / 22500) * 100);
            const backupTime = Math.round(totalSolar / 50);
            let report = `
Site : TTC TELING
ME Standby
${petugasList}


Hari/Tanggal: ${val(data.tanggal_formatted)}
Waktu : ${val(data.jam)} WITA
PLN ON

BP    : ${val(data.bp)}
LBP   : ${val(data.lbp)}
TOTAL : ${val(data.total)}
KVA   : ${val(data.kvar)}

Capacity Trafo ${val(data.TrafoCaps)} KVA
Genset Failed/Total : ${val(data.GensetF)}/ ${val(data.GensetTotal)}
PAC Failled/Total : ${val(data.PACF)}/ ${val(data.PACTotal)}
Rect Failed /Total : ${val(data.RECF)}/ ${val(data.RECTotal)}
UPS Failed/Total : ${val(data.UPSF)}/ ${val(data.UPSTotal)}
---------------------------------------------
Ruang A3 (Lt1)
PAC Type : RCG 60 KW 2 UNIT
${val(data.pac1_Nama)} : ${val(data.pac1_Status)}
Setpoint : ${val(data.pac1_SetPoint)}
Suhu :  ${val(data.pac1_Suhu)}/${val(data.pac1_Kelembaban)} %
${val(data.pac2_Nama)} : ${val(data.pac2_Status)}
Setpoint : ${val(data.pac2_SetPoint)}
Suhu :  ${val(data.pac2_Suhu)}/${val(data.pac2_Kelembaban)} %

UPS 1.2.01 ${val(data.ups1_brand)} ${val(data.ups1_type)} KVA
LOAD
- ${val(data.ups1_kw)} A
- ${val(data.ups1_kw)} KW / ${val(data.ups1_occ)}%
- ${val(data.ups1_kva)} KVA
- Battery : ${val(data.ups1_battery)}

UPS 1.2.02 ${val(data.ups2_brand)} ${val(data.ups2_type)} KVA
LOAD
- ${val(data.ups2_kw)} A
- ${val(data.ups2_kw)} KW / ${val(data.ups2_occ)}
- ${val(data.ups2_kva)} KVA
- Battery : ${val(data.ups2_battery)}

Update Rectifier :
${[...Array(9)].map((_, idx) => {
                let r = idx + 1;
                return `${val(data[`rec${r}_Nama`])}
Load Curr : ${val(data[`rec${r}_TotalLoad`])} A
Occupancy : ${val(data[`rec${r}_Ocupanccy`])} %`;
            }).join("\n")}
Total modul 24
Tekanan FM200
Tabung 1 : 25 Bar/360 Psi/70 Â°F

Suhu Ruangan : ${val(data.battery)} Â°C
---------------------------------------------

Ruang A4 (lt1)
PAC Type : RCG 60 KW 2 UNIT
${val(data.pac3_Nama)} : ${val(data.pac3_Status)}
Setpoint : ${val(data.pac3_SetPoint)}
Suhu :  ${val(data.pac3_Suhu)}/${val(data.pac3_Kelembaban)} %
${val(data.pac4_Nama)} : ${val(data.pac2_Status)}
Setpoint : ${val(data.pac4_SetPoint)}
Suhu :  ${val(data.pac4_Suhu)}/${val(data.pac4_Kelembaban)} %

Tekanan FM200
Tabung 1 : 24 Bar/350 Psi/60 Â°F

${val(data.dcpdu1_noDCPDU)}
Source : ${val(data.dcpdu1_source)}
Voltage/Load
Group A : ${val(data.dcpdu1_aV)}/${val(data.dcpdu1_aA)}
Group B : ${val(data.dcpdu1_bV)}/${val(data.dcpdu1_bA)}
Group C : ${val(data.dcpdu1_cV)}/${val(data.dcpdu1_cA)}
Group D : ${val(data.dcpdu1_dV)}/${val(data.dcpdu1_dA)}

Suhu Ruangan : ${val(data.ran)} Â°C
---------------------------------------------

Ruang B2 (lt2)
PAC Type : RCG 30 KW 2 UNIT
${val(data.pac9_Nama)} : ${val(data.pac9_Status)}
Setpoint : ${val(data.pac9_SetPoint)}
Suhu :  ${val(data.pac9_Suhu)}/${val(data.pac9_Kelembaban)} %
${val(data.pac10_Nama)} : ${val(data.pac10_Status)}
Setpoint : ${val(data.pac10_SetPoint)}
Suhu :  ${val(data.pac10_Suhu)}/${val(data.pac10_Kelembaban)} %

Tekanan FM200
Tabung 1 : 25 Bar/360 psi/70 Â°F

Suhu Ruangan : ${val(data.transmissi)} Â°C
---------------------------------------------

Ruang B4 (lt2)
PAC Type : RCG 60 KW 4 UNIT
${val(data.pac5_Nama)} : ${val(data.pac5_Status)}
Setpoint : ${val(data.pac5_SetPoint)}
Suhu :  ${val(data.pac5_Suhu)}/${val(data.pac5_Kelembaban)} %
${val(data.pac6_Nama)} : ${val(data.pac6_Status)}
Setpoint : ${val(data.pac6_SetPoint)}
Suhu :  ${val(data.pac6_Suhu)}/${val(data.pac6_Kelembaban)} %
${val(data.pac7_Nama)} : ${val(data.pac7_Status)}
Setpoint : ${val(data.pac7_SetPoint)}
Suhu :  ${val(data.pac7_Suhu)}/${val(data.pac7_Kelembaban)} %
${val(data.pac8_Nama)} : ${val(data.pac8_Status)}
Setpoint : ${val(data.pac8_SetPoint)}
Suhu :  ${val(data.pac8_Suhu)}/${val(data.pac8_Kelembaban)} %

Tekanan FM200
Tabung 1 : 25 Bar/360 psi/70 Â°F
Tabung 2 : 25 Bar/360 psi/70 Â°F

${val(data.dcpdu2_noDCPDU)}
Source : ${val(data.dcpdu2_source)}
Voltage/Load
Group A : ${val(data.dcpdu2_aV)}/${val(data.dcpdu2_aA)}
Group B : ${val(data.dcpdu2_bV)}/${val(data.dcpdu2_bA)}
${val(data.dcpdu3_noDCPDU)}
Source : ${val(data.dcpdu3_source)}
Voltage/Load
Group A : ${val(data.dcpdu3_aV)}/${val(data.dcpdu3_aA)}
Group B : ${val(data.dcpdu3_bV)}/${val(data.dcpdu3_bA)}
${val(data.dcpdu4_noDCPDU)}
Source : ${val(data.dcpdu4_source)}
Voltage/Load
Group A : ${val(data.dcpdu4_aV)}/${val(data.dcpdu4_aA)}
Group B : ${val(data.dcpdu4_bV)}/${val(data.dcpdu4_bA)}




Suhu Ruangan : 21 Â°C
---------------------------------------------

Ruang Genset
LVMDP 1
R-S/R-N : ${val(data.lvmdp1_load_r_s)}/${val(data.lvmdp1_load_r_n)} V
R-T/S-N : ${val(data.lvmdp1_load_r_t)}/${val(data.lvmdp1_load_s_n)} V
S-T/T-N : ${val(data.lvmdp1_load_s_t)}/${val(data.lvmdp1_load_t_n)} V
Arester : Baik
Load LVMPD 1
R : ${val(data.lvmdp1_r)} A
S : ${val(data.lvmdp1_s)} A
T : ${val(data.lvmdp1_t)} A
KW : ${val(data.lvmdp1_load)}
KVA : ${val(data.lvmdp1_kva)}
CosQ : ${val(data.faktor_daya)}

LVMDP 2
R-S/R-N : ${val(data.lvmdp2_load_r_s)}/${val(data.lvmdp2_load_r_n)} V
R-T/S-N : ${val(data.lvmdp2_load_r_t)}/${val(data.lvmdp2_load_s_n)} V
S-T/T-N : ${val(data.lvmdp2_load_s_t)}/${val(data.lvmdp2_load_t_n)} V
Arester : Baik
Load LVMPD 2
R : ${val(data.lvmdp2_r)} A
S : ${val(data.lvmdp2_s)} A
T : ${val(data.lvmdp2_t)} A
KW : ${val(data.lvmdp2_load)}
KVA : ${val(data.lvmdp2_kva)}

Genset
Genset 01 : 500 KVA
Genset 02 : 2X350 KVA
Genset 01 (Standby Auto)
Genset 02 (Standby Auto)
SMU Genset 1 : ${val(data2.hours_mater)}
Suhu Genset 1 :  ${val(data.genset)}
SMU Genset 2A : ${val(data3.hours_mater1)}
Suhu Genset 2A:  ${val(data.genset)}
SMU Genset 2B : ${val(data3.hours_mater2)}
Suhu Genset 2B: ${val(data.genset)}
Level Tangki bulanan 1 (10.000L): ${valNum(data2.liter_bulanan)} L
Level Tangki harian 1 (1500L) :  ${valNum(data2.liter_harian)} L
Level Tangki bulanan 2 (10.000L): ${valNum(data3.liter_bulanan)} L
Level Tangki harian 2 (1000L) : ${valNum(data3.liter_harian)} L
Total Solar : ${valNum(totalSolar)} L
Occupancy BBM : ${occBBM} %
Backup time : ${backupTime} Jam

Suhu Ruangan: ${val(data.genset)} Â°C
---------------------------------------------
AC Portable
Lantai 1 : 5.1 KW 
Lantai 2 : 5.1 KW 
Kondisi Terakhir Rehersal Genset
Genset 1 : ${val(data2.tanggal_formatted)}
Genset 2 : ${val(data3.tanggal_formatted)}
`;


            document.getElementById("isi_report").textContent = report;
        }

        function kwhTeling(data) {
            // kumpulin petugas (ada yg bisa null)
            const petugas = [
                data.Petugas1,
                data.Petugas2,
                data.Petugas3,
                data.Petugas4
            ].filter(Boolean); // buang yg null



            const isi = `
Report Kwh dan Suhu TTC Teling
Hari/Tanggal: ${data.tanggal_formatted}
Pukul: ${data.jam} WITA

STATUS
PLN    : On
Genset : standby

KWH
BP    : ${data.bp}
LBP   : ${data.lbp}
TOTAL : ${data.total}
KVA   : ${data.kvar}

Suhu
R. Trafo         : ${data.RTrafo}
R. Genset        : ${data.RGenset}
R. Ran           : ${data.RRan}
R. Control       : ${data.RKontrol}
R. Battery       : ${data.RBattery}
R. Transmissi    : ${data.RTransmissi}
R. Core          : ${data.RCore}

ME    : 
${petugas.map(nama => " - " + nama).join("\n")}

Cuaca : Mendung
Power dan suhu ruangan aman.
  `;

            document.getElementById("isi_report").textContent = isi;
        }

        function ceklistPaniki(data) {
            function val(x) {
                return (x === null || x === undefined || x === "") ? "-" : x;
            }


            // Handle petugas dari Petugas1..4
            let petugas = [data.Petugas1, data.Petugas2, data.Petugas3, data.Petugas4].filter(Boolean);
            let petugasList = petugas.length > 0 ? petugas.map(p => ` - ${p}`).join("\n") : " - Tidak ada petugas standby";
            let report = `
Site : TTC TELING
ME Standby
${petugasList}

Hari/Tanggal: ${val(data.tanggal_formatted)}
Waktu : ${val(data.jam)} WITA
PLN ON

BP    : ${val(data.bp)}
LBP   : ${val(data.lbp)}
TOTAL : ${val(data.total)}
KVA   : ${val(data.kvar)}

Capacity Trafo ${val(data.TrafoCaps)} KVA
Genset Failed/Total : ${val(data.GensetF)}/ ${val(data.GensetTotal)}
PAC Failled/Total : ${val(data.PACF)}/ ${val(data.PACTotal)}
Rect Failed /Total : ${val(data.RECF)}/ ${val(data.RECTotal)}
UPS Failed/Total : ${val(data.UPSF)}/ ${val(data.UPSTotal)}
---------------------------------------------
Ruang A3 (Lt1)
PAC Type : RCG 60 KW 2 UNIT
RCG 1 : ${val(data.pac1_Status)}
Setpoint : ${val(data.pac1_SetPoint)}
Suhu :  ${val(data.pac1_Suhu)}/${val(data.pac1_Kelembaban)} %
RCG 2 : ${val(data.pac2_Status)}
Setpoint : ${val(data.pac2_SetPoint)}
Suhu :  ${val(data.pac2_Suhu)}/${val(data.pac2_Kelembaban)} %

UPS 1.2.01 ${val(data.ups1_brand)} ${val(data.ups1_type)} KVA
LOAD
- ${val(data.ups1_kw)} A
- ${val(data.ups1_kw)} KW
- ${val(data.ups1_kva)} KVA/${val(data.ups1_occ)}
- Battery : ${val(data.ups1_battery)}

UPS 1.2.02 ${val(data.ups2_brand)} ${val(data.ups2_type)} KVA
LOAD
- ${val(data.ups2_kw)} A
- ${val(data.ups2_kw)} KW
- ${val(data.ups2_kva)} KVA/${val(data.ups2_occ)}
- Battery : ${val(data.ups2_battery)}

Update Rectifier :
${val(data.rec1_Nama)}
Bus Voltage : ${val(data.rec1_CapsRec)}
Load        : ${val(data.rec1_BebanTotal)}
Occupancy   : ${val(data.rec1_Ocupanccy)}
${val(data.rec2_Nama)}
Bus Voltage : ${val(data.rec2_CapsRec)}
Load        : ${val(data.rec2_BebanTotal)}
Occupancy   : ${val(data.rec2_Ocupanccy)}
${val(data.rec3_Nama)}
Bus Voltage : ${val(data.rec3_CapsRec)}
Load        : ${val(data.rec3_BebanTotal)}
Occupancy   : ${val(data.rec3_Ocupanccy)}
${val(data.rec4_Nama)}
Bus Voltage : ${val(data.rec4_CapsRec)}
Load        : ${val(data.rec4_BebanTotal)}
Occupancy   : ${val(data.rec4_Ocupanccy)}
${val(data.rec5_Nama)}
Bus Voltage : ${val(data.rec5_CapsRec)}
Load        : ${val(data.rec5_BebanTotal)}
Occupancy   : ${val(data.rec5_Ocupanccy)}
${data.rec6_Nama}
Bus Voltage : ${val(data.rec6_CapsRec)}
Load        : ${val(data.rec6_BebanTotal)}
Occupancy   : ${val(data.rec6_Ocupanccy)}
${val(data.rec7_Nama)}
Bus Voltage : ${val(data.rec7_CapsRec)}
Load        : ${val(data.rec7_BebanTotal)}
Occupancy   : ${val(data.rec7_Ocupanccy)}
${val(data.rec8_Nama)}
Bus Voltage : ${val(data.rec8_CapsRec)}
Load        : ${val(data.rec8_BebanTotal)}
Occupancy   : ${val(data.rec8_Ocupanccy)}
${val(data.rec9_Nama)}
Bus Voltage : ${val(data.rec9_CapsRec)}
Load        : ${val(data.rec9_BebanTotal)}
Occupancy   : ${val(data.rec9_Ocupanccy)}  

Suhu Ruangan : ${val(data.core)} Â°C
---------------------------------------------

Ruang A4 (lt1)
PAC Type : RCG 60 KW 2 UNIT
RCG 1 : ${val(data.pac1_Status)}
Setpoint : ${val(data.pac1_SetPoint)}
Suhu :  ${val(data.pac1_Suhu)}/${val(data.pac1_Kelembaban)} %
RCG 2 : ${val(data.pac2_Status)}
Setpoint : ${val(data.pac2_SetPoint)}
Suhu :  ${val(data.pac2_Suhu)}/${val(data.pac2_Kelembaban)} %

Tekanan FM200
Tabung 1 : 24 Bar/350 Psi/60 Â°F

DCPDU 1.3.1
Source
Voltage/Load
Group A : 51.9/64.6
Group B : 51.9/59.8
Group C : 51.9/85.7
Group D : 52/68.9

Suhu Ruangan : 24 Â°C
---------------------------------------------

Ruang Genset
LVMDP 1
R : ${val(data.lvmdp1_r)} A
S : ${val(data.lvmdp1_s)} A
T : ${val(data.lvmdp1_t)} A
KW : ${val(data.lvmdp1_load)}
KVA : ${val(data.lvmdp1_kva)}
CosQ : ${val(data.faktor_daya)}

LVMDP 2
R : ${val(data.lvmdp2_r)} A
S : ${val(data.lvmdp2_s)} A
T : ${val(data.lvmdp2_t)} A
KW : ${val(data.lvmdp2_load)}
KVA : ${val(data.lvmdp2_kva)}

Total Load PLN : ${val(data.total_load_pln)} A
Occupancy PLN : ${val(data.occupancy_pln)}

Suhu Ruangan: ${val(data.genset)} Â°C
---------------------------------------------
AC Portable
Lantai 1 : - 
Lantai 2 : - 
Kondisi Terakhir Rehersal Genset
Genset 1 : ${val(data.tanggal_formatted)}
Genset 2 : ${val(data.tanggal_formatted)}
`;

            document.getElementById("isi_report").textContent = report;
        }



        const btnCopy = document.getElementById("btnCopy");
        const isiReport = document.getElementById("isi_report");

        // Fungsi copy
        function copyReport() {
            // Gunakan Clipboard API
            navigator.clipboard.writeText(isiReport.textContent)
                .then(() => {
                    Swal.fire({ toast: true, position: "top-end", icon: "success", title: "Saved!", showConfirmButton: false, timer: 1500 });
                })
                .catch(err => {
                    console.error("Gagal copy: ", err);
                });
        }

        // Pasang event listener ke tombol
        btnCopy.addEventListener("click", copyReport);
    </script>

</body>

</html>
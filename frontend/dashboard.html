<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoring Dashboard</title>
  <link rel="stylesheet" href="src/Font-Awesome-6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="src/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link href="src/bootstrap-5.3.6-dist/bootstrap-5.3.6-dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="css/sidebar.css" />
</head>
<body>  
  <header>
    <div class="menu-button"><i class="fas fa-bars" id="openSidebar"></i></div>
    <img src="asset/TelkomselLogo.png" alt="Telkomsel Logo" class="logo" />
  </header>

  <div id="overlay" class="overlay"></div>
  <div id="mySidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="asset/TelkomselLogo.png" alt="Telkomsel Logo" class="logo" />
    </div>
    <span class="closebtn" id="closeSidebar">&times;</span>
    <ul class="menu">
      <li id="log-out"><i class="fas fa-right-from-bracket"></i> Log Out</li>
      <li id="data-tracking"><i class="fas fa-clipboard-list"></i> Data Tracking</li>
      <li id="monitoring"><i class="fas fa-clipboard-list"></i> Monitoring</li>
      <li id="alarm"><i class="fas fa-clipboard-list"></i> Alarm</li>
    </ul>
  </div>

  <h1>MONITORING DASHBOARD</h1>

  <div class="dashboard">
    <div class="box">
      <h3>PUE</h3>
      <canvas id="sunburstChart"></canvas>
    </div>

    <div class="box">
      <h3>PUE</h3>
      <canvas id="lineChart"></canvas>
    </div>

    <div class="box temp-box">
      <div class="temp-item"><div class="info"><strong>Battery RAN</strong><br>25°C<br><small>H: 60%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Battery Core</strong><br>26°C<br><small>H: 62%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>NFVI</strong><br>28°C<br><small>H: 58%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>RAN</strong><br>30°C<br><small>H: 55%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Core</strong><br>27°C<br><small>H: 59%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Interkoneksi</strong><br>29°C<br><small>H: 57%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Trafo</strong><br>24°C<br><small>H: 63%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Genset</strong><br>24°C<br><small>H: 63%</small></div><i class="fas fa-thermometer-half"></i></div>
    </div>

    <div class="box">
      <h3>LOAD TTC</h3>
      <canvas id="loadTTCChart"></canvas>
    </div>

    <div class="box">
      <h3>LOAD TTC</h3>
      <canvas id="plnLineChart"></canvas>
    </div>

    <div class="box">
      <h3>BBM <img src="Gambar/Gas Station.png" alt="BBM Logo" class="bbm-logo"></h3>
      <canvas id="bbmChart"></canvas>
    </div>
  </div>
  
  <h1 style="margin-top: 20px;">AVERAGE PUE</h1>
  <div class="box" id="table-dialy">
    <table>
      <thead>
        <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>kW LV1</th>
            <th>kW LV2</th>
            <th>Total Load PLN</th>
            <th>kW UPS1</th>
            <th>kW UPS2</th>
            <th>kW Rec 1</th>
            <th>kW Rec 2</th>
            <th>kW Rec 3</th>
            <th>kW Rec 4</th>
            <th>Total Load IT Telco</th>
            <th>Facility</th>
            <th>PUE</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="frontend/js/sidebar.js"></script>

  <script>
    const hours = [...Array(24).keys()].map(h => h.toString().padStart(2, '0') + ':00');

    // === PUE Donut Chart ===
    const ctx = document.getElementById('sunburstChart').getContext('2d');
    const centerTextPlugin = {
      id: 'centerText',
      beforeDraw(chart) {
        const { width, height, ctx } = chart;
        ctx.restore();
        const fontSize = (height / 114).toFixed(2);
        ctx.font = `${fontSize}em sans-serif`;
        ctx.textBaseline = "middle";
        ctx.fillStyle = chart.config.data.datasets[0].backgroundColor[0];
        const text = `${chart.config.data.datasets[0].data[0]}`;
        const textX = Math.round((width - ctx.measureText(text).width) / 2);
        const textY = height / 2;
        ctx.fillText(text, textX, textY);
        ctx.save();
      }
    };
    const pueChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Used', 'Remaining'],
        datasets: [{ data: [1.2, 2.8], backgroundColor: ['#008000', '#e0e0e0'] }]
      },
      options: { cutout: '70%', plugins: { tooltip: { enabled: false }, legend: { display: false } } },
      plugins: [centerTextPlugin]
    });
    async function updatePUE() {
      try {
        const response = await fetch('/api/ttc_paniki/monitoring/last-cache-pue');
        const data = await response.json();
        const usedValue = parseFloat(data.pue);
        const remainingValue = Math.max(0, 4 - usedValue);
        let usedColor = '#008000';
        if (usedValue >= 2) usedColor = '#f44336';
        else if (usedValue >= 1.7) usedColor = '#ff9800';
        pueChart.data.datasets[0].data = [usedValue, remainingValue];
        pueChart.data.datasets[0].backgroundColor = [usedColor, '#e0e0e0'];
        pueChart.update();
      } catch (error) { console.error('Gagal mengambil data PUE:', error); }
    }
    setInterval(updatePUE, 1000);
    updatePUE();

    // === PUE Line Chart ===
    const ctx2 = document.getElementById('lineChart').getContext('2d');
    const chart = new Chart(ctx2, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'PUE', data: [], fill: true, borderColor: '#2196f3', backgroundColor: 'rgba(33, 150, 243, 0.2)', tension: 0.3 }] },
      options: { scales: { y: { min: 1, max: 2.5, ticks: { stepSize: 0.5, callback: v => [1,1.5,2,2.5].includes(v)?v:null } } } }
    });
    async function fetchDataAndUpdateChartPUE() {
      try {
        const response = await fetch('/api/ttc_paniki/monitoring/all-pue');
        const data = await response.json();
        const labels = data.map(item => `${item.jam.toString().padStart(2,'0')}:00`);
        const pueValues = data.map(item => item.pue);
        chart.data.labels = labels;
        chart.data.datasets[0].data = pueValues;
        chart.update();
      } catch (error) { console.error('Error fetching data:', error); }
    }
    fetchDataAndUpdateChartPUE();
    setInterval(fetchDataAndUpdateChartPUE, 300000);

    // === PLN Load Line Chart ===
    const ctx4 = document.getElementById('plnLineChart').getContext('2d');
    const chartLOAD = new Chart(ctx4, {
      type: 'line',
      data: { labels: [], datasets: [{ label:'PLN', data: [], borderColor:'Blue', tension:0.4 },{label:'Load Facility', data: [], borderColor:'green', tension:0.4},{label:'IT & Telco', data: [], borderColor:'red', tension:0.4 }] },
      options: { responsive:true, plugins:{ legend:{ position:'top' } } }
    });
    function fetchDataAndUpdateLineLoad() {
      fetch('/api/ttc_paniki/monitoring/all-pue')
        .then(r => r.json())
        .then(data => {
          chartLOAD.data.labels = data.map(i => i.jam);
          chartLOAD.data.datasets[0].data = data.map(i => i.pln);
          chartLOAD.data.datasets[1].data = data.map(i => i.facility);
          chartLOAD.data.datasets[2].data = data.map(i => i.it);
          chartLOAD.update();
        })
        .catch(err => console.error('Gagal memuat data:', err));
    }
    fetchDataAndUpdateLineLoad();
    setInterval(fetchDataAndUpdateLineLoad, 1000);

    // === BBM Chart ===
    const ctx5 = document.getElementById('bbmChart').getContext('2d');
    const bbmChart = new Chart(ctx5, {
      type:'bar',
      data:{ labels:['Tank Harian G1','Tank Bulanan G1','Tank Harian G2'], datasets:[{label:'Occupancy (%)', data:[0,0,0], backgroundColor:'red'}] },
      options:{ scales:{ y:{ beginAtZero:true, min:0, max:100, ticks:{ stepSize:25 } } } }
    });
    async function updateChartBBM() {
      try {
        const response = await fetch('/api/ttc_paniki/monitoring/bbm');
        const data = await response.json();
        bbmChart.data.datasets[0].data = [parseFloat(data.tank_harian1), parseFloat(data.tank_bulanan), parseFloat(data.tank_harian2)];
        bbmChart.update();
      } catch(err) { console.error('Gagal mengambil data dari API:', err); }
    }
    updateChartBBM();
    setInterval(updateChartBBM, 1000);

    // === Load TTC Bar Chart ===
    const ctx3 = document.getElementById('loadTTCChart').getContext('2d');
    const loadTTCChart = new Chart(ctx3, {
      type:'bar',
      data:{ labels:['PLN','Load Facility','IT & Telco'], datasets:[{ label:'Load (KW)', data:[0,0,0], backgroundColor:['Blue','green','red'] }] },
      options:{
        plugins:{ legend:{ display:false }, datalabels:{ color:'white', anchor:'center', align:'center', font:{weight:'bold', size:22}, formatter:v=>v.toFixed(1)+'KW' } },
        scales:{ y:{ beginAtZero:true } }
      },
      plugins:[ChartDataLabels]
    });
    function updateChartLoad() {
      fetch('/api/ttc_paniki/monitoring/last-cache-pue')
        .then(r=>r.json())
        .then(d=>{
          loadTTCChart.data.datasets[0].data = [d.pln,d.facility,d.it];
          loadTTCChart.update();
        })
        .catch(err=>console.error(err));
    }
    updateChartLoad();
    setInterval(updateChartLoad,1000);

    // === Suhu ===
    function updateSuhu() {
      fetch('/api/ttc_paniki/monitoring/suhu')
        .then(r=>r.json())
        .then(d=>{
          const suhuData = {
            'Battery RAN': { temp:d.suhu_batran, hum:d.temp_batran },
            'Battery Core': { temp:d.suhu_batcore, hum:d.temp_batcore },
            'NFVI': { temp:d.suhu_nfvi, hum:d.temp_nfvi },
            'RAN': { temp:d.suhu_ran, hum:d.temp_ran },
            'Core': { temp:d.suhu_core, hum:d.temp_core },
            'Interkoneksi': { temp:d.suhu_inter, hum:d.temp_inter },
            'Trafo': { temp:d.suhu_trafo, hum:d.temp_trafo },
            'Genset': { temp:d.suhu_genset, hum:d.temp_genset }
          };
          document.querySelectorAll('.temp-item .info').forEach(info=>{
            const label = info.querySelector('strong').innerText.replace('\n',' ').trim();
            if(suhuData[label]){
              info.innerHTML = `<strong>${label.replace(' ','<br>')}</strong><br>${suhuData[label].temp.toFixed(1)}°C<br><small>H: ${suhuData[label].hum.toFixed(0)}%</small>`;
            }
          });
        })
        .catch(err=>console.error('Gagal mengambil data suhu:',err));
    }
    updateSuhu();
    setInterval(updateSuhu,5000);

    // === Table Latest 7 Day ===
    function fetchAndUpdateTable() {
      fetch('/api/ttc_paniki/monitoring/average-pue')
        .then(r=>r.json())
        .then(data=>{
          const tbody = document.querySelector('#table-dialy tbody');
          tbody.innerHTML = '';
          data.forEach((item,index)=>{
            const facilityLOAD = parseFloat(item.avg_pln)-parseFloat(item.avg_it_telco);
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${index+1}</td>
              <td>${item.date}</td>
              <td>${parseFloat(item.avg_kw_lvmdp1).toFixed(2)}</td>
              <td>${parseFloat(item.avg_kw_lvmdp2).toFixed(2)}</td>
              <td>${parseFloat(item.avg_pln).toFixed(2)}</td>
              <td>${parseFloat(item.avg_kw_ups1).toFixed(2)}</td>
              <td>${parseFloat(item.avg_kw_ups2).toFixed(2)}</td>
              <td>${parseFloat(item.avg_kw_rec1).toFixed(2)}</td>
              <td>${parseFloat(item.avg_kw_rec2).toFixed(2)}</td>
              <td>${parseFloat(item.avg_kw_rec3).toFixed(2)}</td>
              <td>${parseFloat(item.avg_kw_rec4).toFixed(2)}</td>
              <td>${parseFloat(item.avg_it_telco).toFixed(2)}</td>
              <td>${facilityLOAD.toFixed(2)}</td>
              <td>${parseFloat(item.avg_pue).toFixed(3)}</td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch(err=>console.error('Gagal mengambil data:',err));
    }
    fetchAndUpdateTable();
    setInterval(fetchAndUpdateTable,3600000);

    // === Alarm ===
    function cekAlarm(){
      fetch('/api/ttc_paniki/monitoring/all-pue')
        .then(r=>r.json())
        .then(data=>{
          data.forEach(item=>{
            if(item.status==1){
              const message = `${item.facility} ${item.device} overload`;
              Swal.fire({icon:'warning',title:'Alarm',text:message});
            }
          });
        }).catch(err=>console.error(err));
    }
    setInterval(cekAlarm,5000);
  </script>
</body>
</html>

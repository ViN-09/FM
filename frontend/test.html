<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoring Dashboard</title>
    <link rel="stylesheet" href="src/Font-Awesome-6.4.0/css/all.min.css" />
    <script src="src/chart.js"></script>
    <script src="src/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>
    <script src="src/node_modules/chartjs-plugin-datalabels/dist/chartjs-plugin-datalabels.js"></script>
    <link href="src/bootstrap-5.3.6-dist/bootstrap-5.3.6-dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/test.css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <title>FACILITY MONITORING</title>
</head>
<body>  
  <header>
    <div class="menu-button"><i class="fas fa-bars" id="openSidebar"></i></div>
    <img src="Gambar/Telkomsel Logo.png" alt="Telkomsel Logo" class="logo" />
  </header>
  <div id="overlay" class="overlay"></div><!--Sidebar-->

  <div id="mySidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="Gambar/telkom.png" alt="Telkomsel Logo" class="logo">
    </div>
    <span class="closebtn" id="closeSidebar">&times;</span>
    <ul class="menu">
      <li id="log-out"><i class="fas fa-right-from-bracket"></i> Log Out</li>
      <li id="data-tracking"><i class="fas fa-clipboard-list"></i> Data Tracking</li>
      <li id="log-alarm"><i class="fas fa-bell"></i> Alarm</li>
    </ul>
  </div>
  <h1>MONITORING DASHBOARD</h1>

  <div class="dashboard">
    <div class="box">
      <h3>PUE</h3>
      <canvas id="sunburstChart"></canvas>
    </div>

    <div class="box">
      <h3>PUE</h3>
      <canvas id="lineChart"></canvas>
    </div>

    <div class="box temp-box">
      <div class="temp-item"><div class="info"><strong>Battery RAN</strong><br>25°C<br><small>H: 60%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Battery Core</strong><br>26°C<br><small>H: 62%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>NFVI</strong><br>28°C<br><small>H: 58%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>RAN</strong><br>30°C<br><small>H: 55%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Core</strong><br>27°C<br><small>H: 59%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Interkoneksi</strong><br>29°C<br><small>H: 57%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Trafo</strong><br>24°C<br><small>H: 63%</small></div><i class="fas fa-thermometer-half"></i></div>
      <div class="temp-item"><div class="info"><strong>Genset</strong><br>24°C<br><small>H: 63%</small></div><i class="fas fa-thermometer-half"></i></div>
    </div>

    <div class="box">
      <h3>LOAD TTC</h3>
      <canvas id="loadTTCChart"></canvas>
    </div>

    <div class="box">
      <h3>LOAD TTC</h3>
      <canvas id="plnLineChart"></canvas>
    </div>

    <div class="box">
      <h3>BBM <img src="Gambar/Gas Station.png" alt="BBM Logo" class="bbm-logo"></h3>
      <canvas id="bbmChart"></canvas>
    </div>
  </div>
  
  <h1 style="margin-top: 20px;">AVERAGE PUE</h1>
  <div class="box" id="table-dialy">
    <table>
      <thead>
        <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>kW LV1</th>
            <th>kW LV2</th>
            <th>Total Load PLN</th>
            <th>kW UPS1</th>
            <th>kW UPS2</th>
            <th>kW Rec 1</th>
            <th>kW Rec 2</th>
            <th>kW Rec 3</th>
            <th>kW Rec 4</th>
            <th>Total Load IT Telco</th>
            <th>Facility</th>
            <th>PUE</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const hours = [...Array(24).keys()].map(h => h.toString().padStart(2, '0') + ':00');

  //PUE Donat
  const ctx = document.getElementById('sunburstChart').getContext('2d');

// Plugin untuk menampilkan nilai di tengah donat
const centerTextPlugin = {
  id: 'centerText',
  beforeDraw(chart) {
    const { width, height, ctx } = chart;
    ctx.restore();
    const fontSize = (height / 114).toFixed(2);
    ctx.font = `${fontSize}em sans-serif`;
    ctx.textBaseline = "middle";

    // Ambil warna teks sesuai warna used (warna pertama di backgroundColor)
    ctx.fillStyle = chart.config.data.datasets[0].backgroundColor[0];

    const text = `${chart.config.data.datasets[0].data[0]}`;
    const textX = Math.round((width - ctx.measureText(text).width) / 2);
    const textY = height / 2;

    ctx.fillText(text, textX, textY);
    ctx.save();
  }
};

// Inisialisasi chart
const pueChart = new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Used', 'Remaining'],
    datasets: [{
      data: [1.2, 2.8], // Nilai awal sementara
      backgroundColor: ['#008000', '#e0e0e0']
    }]
  },
  options: {
    cutout: '70%',
    plugins: {
      tooltip: { enabled: false },
      legend: { display: false }
    }
  },
  plugins: [centerTextPlugin]
});

// Fungsi untuk mengambil data dari API dan update chart
async function updatePUE() {
  try {
    const response = await fetch('API-PUE-Realtime.php');
    const data = await response.json(); // Respon: { "pue": 1.5 }

    const usedValue = parseFloat(data.pue);
    const remainingValue = Math.max(0, 4 - usedValue); // Misal total maksimal PUE = 4

    // Tentukan warna berdasarkan nilai PUE
    let usedColor = '#008000'; // Hijau
    if (usedValue >= 2) {
      usedColor = '#f44336'; // Merah
    } else if (usedValue >= 1.7) {
      usedColor = '#ff9800'; // Oranye
    }

    // Update data dan warna
    pueChart.data.datasets[0].data = [usedValue, remainingValue];
    pueChart.data.datasets[0].backgroundColor = [usedColor, '#e0e0e0'];
    pueChart.update();
  } catch (error) {
    console.error('Gagal mengambil data PUE:', error);
  }
}

// Update setiap 1 detik
setInterval(updatePUE, 1000);
updatePUE(); // Panggil sekali saat pertama load
  //Pue donat


  //chart PUE
    // Membuat chart kosong terlebih dahulu dengan ctx2
    const ctx2 = document.getElementById('lineChart').getContext('2d');
const chart = new Chart(ctx2, {
  type: 'line',
  data: {
    labels: [], // Akan diisi dari API
    datasets: [{
      label: 'PUE',
      data: [],
      fill: true,
      borderColor: '#2196f3',
      backgroundColor: 'rgba(33, 150, 243, 0.2)',
      tension: 0.3
    }]
  },
  options: {
    scales: {
      y: {
        min: 1,
        max: 2.5,
        ticks: {
          stepSize: 0.5,
          callback: function(value) {
            return [1, 1.5, 2, 2.5].includes(value) ? value : null;
          }
        }
      }
    }
  }
});

// Fungsi untuk mengambil data dari API dan memperbarui chart
async function fetchDataAndUpdateChartPUE() {
  try {
    const response = await fetch('API-PUE-Dialy.php');
    const data = await response.json();
    
    // Ambil label jam (00:00–23:00)
    const labels = data.map(item => `${item.jam.toString().padStart(2, '0')}:00`);
    
    // Ambil nilai PUE
    const pueValues = data.map(item => item.pue);

    // Perbarui chart
    chart.data.labels = labels;
    chart.data.datasets[0].data = pueValues;
    chart.update();

  } catch (error) {
    console.error('Error fetching data:', error);
  }
}

// Jalankan saat halaman dimuat
fetchDataAndUpdateChartPUE();

// Refresh data setiap 5 menit (300000 ms)
setInterval(fetchDataAndUpdateChartPUE, 300000);
    //chart PUE


    //LOAD Line
    const ctx4 = document.getElementById('plnLineChart').getContext('2d');
    const chartLOAD = new Chart(ctx4, {  // Changed chart2 to chartLOAD
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'PLN', data: [], borderColor: 'Blue', tension: 0.4 },
          { label: 'Load Facility', data: [], borderColor: 'green', tension: 0.4 },
          { label: 'IT & Telco', data: [], borderColor: 'red', tension: 0.4 }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top'
          }
        }
      }
    });

    function fetchDataAndUpdateLineLoad() {
      fetch('API-PUE-Dialy.php')
        .then(response => response.json())
        .then(data => {
          chartLOAD.data.labels = data.map(item => item.jam);  // Updated to chartLOAD
          chartLOAD.data.datasets[0].data = data.map(item => item.pln);  // Updated to chartLOAD
          chartLOAD.data.datasets[1].data = data.map(item => item.facility);  // Updated to chartLOAD
          chartLOAD.data.datasets[2].data = data.map(item => item.it);  // Updated to chartLOAD
          chartLOAD.update();  // Updated to chartLOAD
        })
        .catch(error => console.error('Gagal memuat data:', error));
    }

    fetchDataAndUpdateLineLoad();
    setInterval(fetchDataAndUpdateLineLoad, 1000);
    //LOAD Line

    //bbm
          const ctx5 = document.getElementById('bbmChart').getContext('2d');

      const bbmChart = new Chart(ctx5, {
        type: 'bar',
        data: {
          labels: ['Tank Harian G1', 'Tank Bulanan G1', 'Tank Harian G2'],  // Menghapus Tank Bulanan G2
          datasets: [{
            label: 'Occupancy (%)',
            data: [0, 0, 0], // Awalnya nol
            backgroundColor: 'red'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              min: 0,
              max: 100,
              ticks: { stepSize: 25 }
            }
          }
        }
      });

      async function updateChartBBM() {
        try {
          const response = await fetch('API-BBM-Realtime.php');
          const data = await response.json();

          // Menyesuaikan pengambilan data dengan model isian API baru
          const occValues = [
            parseFloat(data.tank_harian1),   // Tank Harian G1
            parseFloat(data.tank_bulanan),   // Tank Bulanan G1
            parseFloat(data.tank_harian2)    // Tank Harian G2
          ];

          bbmChart.data.datasets[0].data = occValues;
          bbmChart.update();
        } catch (error) {
          console.error('Gagal mengambil data dari API:', error);
        }
      }

      updateChartBBM();
      setInterval(updateChartBBM, 1000);

    //bbm

    //Load Chart
        const ctx3 = document.getElementById('loadTTCChart').getContext('2d');

        const loadTTCChart = new Chart(ctx3, {
          type: 'bar',
          data: {
            labels: ['PLN', 'Load Facility', 'IT & Telco'],
            datasets: [{
              label: 'Load (KW)',
              data: [0, 0, 0],
              backgroundColor: ['Blue', 'green', 'red']
            }]
          },
          options: {
            plugins: {
              legend: {
                display: false
              },
              datalabels: {
                color: 'white',
                anchor: 'center',  // posisi angka
                align: 'center',   // posisi angka
                font: {
                  weight: 'bold',
                  size: 22
                },
                formatter: value => value.toFixed(1) + 'KW' // menampilkan satu angka di belakang koma
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          },
          plugins: [ChartDataLabels] // Aktifkan plugin DataLabels
        });

        // Fungsi update chart
        function updateChartLoad() {
          fetch('API-PUE-Realtime.php')
            .then(response => response.json())
            .then(data => {
              loadTTCChart.data.datasets[0].data = [data.pln, data.facility, data.it];
              loadTTCChart.update();
            })
            .catch(error => console.error('Error fetching data:', error));
        }

        // Update setiap detik
        setInterval(updateChartLoad, 1000);

        // Update pertama kali saat load
        updateChartLoad();

    //LOAD Chart

    //Suhu
    function updateSuhu() {
      fetch('API-Suhu.php')
        .then(response => response.json())
        .then(data => {
          const suhuData = {
            'Battery RAN': {
              temp: parseFloat(data.suhu_batran),  // menggunakan data.suhu_batran untuk temp
              hum: parseFloat(data.temp_batran)    // menggunakan data.temp_batran untuk hum
            },
            'Battery Core': {
              temp: parseFloat(data.suhu_batcore), // menggunakan data.suhu_batcore untuk temp
              hum: parseFloat(data.temp_batcore)   // menggunakan data.temp_batcore untuk hum
            },
            'NFVI': {
              temp: parseFloat(data.suhu_nfvi),    // menggunakan data.suhu_nfvi untuk temp
              hum: parseFloat(data.temp_nfvi)      // menggunakan data.temp_nfvi untuk hum
            },
            'RAN': {
              temp: parseFloat(data.suhu_ran),     // menggunakan data.suhu_ran untuk temp
              hum: parseFloat(data.temp_ran)       // menggunakan data.temp_ran untuk hum
            },
            'Core': {
              temp: parseFloat(data.suhu_core),    // menggunakan data.suhu_core untuk temp
              hum: parseFloat(data.temp_core)      // menggunakan data.temp_core untuk hum
            },
            'Interkoneksi': {
              temp: parseFloat(data.suhu_inter),   // menggunakan data.suhu_inter untuk temp
              hum: parseFloat(data.temp_inter)     // menggunakan data.temp_inter untuk hum
            },
            'Trafo': {
              temp: parseFloat(data.suhu_trafo),   // menggunakan data.suhu_trafo untuk temp
              hum: parseFloat(data.temp_trafo)     // menggunakan data.temp_trafo untuk hum
            },
            'Genset': {
              temp: parseFloat(data.suhu_genset),  // menggunakan data.suhu_genset untuk temp
              hum: parseFloat(data.temp_genset)    // menggunakan data.temp_genset untuk hum
            }
          };

          // Update each .temp-item with the new data
          document.querySelectorAll('.temp-item .info').forEach(info => {
            const label = info.querySelector('strong').innerText.replace('\n', ' ').trim();
            
            if (suhuData[label]) {
              info.innerHTML = `<strong>${label.replace(' ', '<br>')}</strong><br>${suhuData[label].temp.toFixed(1)}°C<br><small>H: ${suhuData[label].hum.toFixed(0)}%</small>`;
            }
          });
        })
        .catch(err => {
          console.error('Gagal mengambil data suhu:', err);
        });
    }

    // Jalankan pertama kali dan ulangi setiap 5 detik
    updateSuhu();
    setInterval(updateSuhu, 5000);

    //suhu

  //Table Latest 7 Day
    function fetchAndUpdateTable() {
        fetch('API-PUE-7Day.php')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#table-dialy tbody');
            tbody.innerHTML = ''; // Kosongkan isi tabel sebelum isi ulang

            data.forEach((item, index) => {
              const row = document.createElement('tr');
              const facilityLOAD = parseFloat(item.avg_pln) - parseFloat(item.avg_it_telco);
              row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.date}</td>
                <td>${parseFloat(item.avg_kw_lvmdp1).toFixed(2)}</td>
                <td>${parseFloat(item.avg_kw_lvmdp2).toFixed(2)}</td>
                <td>${parseFloat(item.avg_pln).toFixed(2)}</td>
                <td>${parseFloat(item.avg_kw_ups1).toFixed(2)}</td>
                <td>${parseFloat(item.avg_kw_ups2).toFixed(2)}</td>
                <td>${parseFloat(item.avg_kw_rec1).toFixed(2)}</td>
                <td>${parseFloat(item.avg_kw_rec2).toFixed(2)}</td>
                <td>${parseFloat(item.avg_kw_rec3).toFixed(2)}</td>
                <td>${parseFloat(item.avg_kw_rec4).toFixed(2)}</td>
                <td>${parseFloat(item.avg_it_telco).toFixed(2)}</td>
                <td>${facilityLOAD.toFixed(2)}</td>
                <td>${parseFloat(item.avg_pue).toFixed(3)}</td>
              `;
              tbody.appendChild(row);
            });

          })
          .catch(error => {
            console.error('Gagal mengambil data:', error);
          });
      }

      // Jalankan saat halaman dimuat
      fetchAndUpdateTable();

      // Jalankan ulang setiap 1 jam (3600000 ms)
      setInterval(fetchAndUpdateTable, 3600000);
  //

  //alarm
  // setInterval(cekAlarm, 10000); RE-cek
        function cekAlarm(){
            fetch('API-Alarm.php')
            .then(response => response.json())
            .then(data => {
                data.forEach(item => {
                const line = `id: ${item.id}, type: ${item.type}, titik: ${item.titik}, status: ${item.status}, sent: ${item.sent}`;
                // console.log(line);
                if(item.status==1){
                    error = `${item.titik} : ${item.type}`;
                    showAlert(error);
                }
                else{
    
                }
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });

        }

        function showAlert(massage) {
            Swal.fire({
            html: `
                <div class="custom-alert-content">
                    <img src="pngwing.png" alt="Custom image" class="custom-alert-icon">
                    <span class="custom-alert-title">${massage}</span>
                </div>
            `,
            showConfirmButton: false,
            position: 'top-end',
            timer: 5000,
            customClass: {
                popup: 'custom-swal-popup', // pakai custom class untuk styling background & isi
            }
        });

        }
  </script>
  <script src="css/sidebar.js"></script>
  <script src="DB_Utility/db_utility.js"></script>
</body>
</html>
